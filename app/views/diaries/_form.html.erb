<%= form_with model: @diary do |f| %>
  <%= render 'shared/error_messages', object: f.object %>

  <div class="mb-3">
    <%= f.label :title %>
    <%= f.text_field :title, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= f.label :thumbnail_image %>
    <%= f.file_field :thumbnail_image, class: "form-control", accept: 'image/*' %>
  </div>

  <% if @diary.thumbnail_image_url.present? %>
    <div class="mb-3">
      <p>現在のサムネイル:</p>
      <img src="<%= @diary.thumbnail_image_url %>" alt="Thumbnail Image" width="200" />
    </div>
  <% end %>
  
  <div class="mb-3 d-flex flex-wrap gap-3">
    <div>
      <%= f.label :plant_name %>
      <%= f.text_field :plant_name, class: "form-control", placeholder: "植物名を入力" %>
    </div>

    <div>
      <%= f.label :variety_name %>
      <%= f.text_field :variety_name, class: "form-control", placeholder: "品種名を入力" %>
    </div>

    <div>
      <%= f.label :cultivation_method %>
      <%= f.select :cultivation_method, 
                   options_for_select(["地植え", "プランター・鉢植え", "その他"]), 
                   { include_blank: "選択してください" }, 
                   class: "form-control" %>
    </div>

    <div>
      <%= f.label :cultivation_location %>
      <%= f.text_field :cultivation_location, class: "form-control", placeholder: "例: 自宅庭, 屋内" %>
    </div>
  </div>

  <div class="mb-3">
    <%= f.label :summary_content %>
    <%= f.text_area :summary_content, class: "form-control", rows: "10" %>
  </div>


  <div id="growth-stage-contents">
    <%= f.fields_for :growth_stages do |growth_stage_form| %>
      <div class="mb-3 growth-stage-item">
        <%= growth_stage_form.hidden_field :id %>
        <%= growth_stage_form.label :growth_stage_contents, t('activerecord.attributes.diary.growth_stage_contents') %>
        <%= growth_stage_form.text_area :growth_stage_contents, class: "form-control growth_stage_content", rows: "4", placeholder: "成長段階を入力" %>
        <%= growth_stage_form.file_field :image, class: "form-control", accept: 'image/*' %>

        <!-- 削除を識別するための隠しフィールド -->
        <%= growth_stage_form.hidden_field :_destroy, value: "false", class: "destroy-hidden-field" %>
        <!-- 削除ボタン -->
        <button type="button" class="btn btn-danger remove-growth-stage-btn"><%= t('buttons.destroy') %></button>
      </div>
    <% end %>
  </div>

  <button type="button" class="btn btn-secondary" id="add-growth-stage-content"><%= t('buttons.add') %></button>
  <%= f.submit t('buttons.save'), class: "btn btn-success" %>
<% end %>

<script>
  // 成長段階削除ボタンの動作設定（既存の要素用）
  document.querySelectorAll('.remove-growth-stage-btn').forEach(function(button) {
    button.addEventListener('click', function() {
      const growthStageItem = this.closest('.growth-stage-item');
      const destroyField = growthStageItem.querySelector('.destroy-hidden-field');
      destroyField.value = "true"; // 削除フラグを立てる
      growthStageItem.style.display = 'none'; // UI上で非表示にする
    });
  });

  // 新しい成長段階を追加する処理
  document.getElementById('add-growth-stage-content').addEventListener('click', function() {
    const container = document.getElementById('growth-stage-contents');

    // インデックスを取得して新しい要素の名前属性に適用
    const index = container.children.length;
    const newItem = document.createElement('div');
    newItem.classList.add('mb-3', 'growth-stage-item');

    newItem.innerHTML = `
      <label for="diary_growth_stages_attributes_${index}_growth_stage_contents">成長段階</label>
      <textarea name="diary[growth_stages_attributes][${index}][growth_stage_contents]" class="form-control growth_stage_content" rows="4" placeholder="⚪︎月⚪︎日"></textarea>
      <input type="file" name="diary[growth_stages_attributes][${index}][image]" class="form-control" accept="image/*">

      <!-- 隠しフィールド（削除用） -->
      <input type="hidden" name="diary[growth_stages_attributes][${index}][_destroy]" value="false" class="destroy-hidden-field">

      <!-- 削除ボタン -->
      <button type="button" class="btn btn-danger remove-growth-stage-btn">この成長段階を削除</button>
    `;

    container.appendChild(newItem);

    // 追加された成長段階の削除ボタンの動作設定
    newItem.querySelector('.remove-growth-stage-btn').addEventListener('click', function() {
      const destroyField = newItem.querySelector('.destroy-hidden-field');
      destroyField.value = "true"; // 削除フラグを立てる
      newItem.style.display = 'none'; // UI上で非表示にする
    });
  });
</script>
